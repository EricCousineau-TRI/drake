# -*- mode: python -*-
# vi: set ft=python :

"""
Provides NumPy from a wheel file.

Example:
    WORKSPACE:
        load("@drake//tools/workspace/numpy_py:repo.bzl", "numpy_py_repository")
        numpy_py_repository(
            name = "numpy_py",
            mirrors = mirrors,
        )

    BUILD:
        py_library(
            name = "foobar",
            deps = ["@numpy_py"],
            srcs = ["bar.py"],
        )

Arguments:
    name: A unique name for this rule.
    mirrors: Mirrors for download that must have entries for "pypi-general".

Warning:
    Do not name this `numpy`, as Bazel will confuse `PYTHONPATH` due to
    `legacy_create_init` behavior. If `numpy` is located in the repo root,
    `random` will be shadowed by `numpy.random`, causing everything to fail.
    If installed elsewhere, Bazel will put an autogenerated `__init__.py` at
    external directory's root, leak the wrong path, and shadow the real
    `numpy`. See https://github.com/bazelbuild/bazel/issues/3998
"""

load("@drake//tools/workspace:os.bzl", "determine_os")

# See: https://pypi.org/project/numpy/#files
wheels = {
    "ubuntu_16.04": {
        "hash_path": "40/c5/f1ed15dd931d6667b40f1ab1c2fe1f26805fc2b6c3e25e45664f838de9d0",  # noqa
        "filename": "numpy-1.15.2-cp27-cp27mu-manylinux1_x86_64.whl",
        "sha256": "82f00a1e2695a0e5b89879aa25ea614530b8ebdca6d49d4834843d498e8a5e92",  # noqa
    },
    "ubuntu_18.04": {
        "hash_path": "40/c5/f1ed15dd931d6667b40f1ab1c2fe1f26805fc2b6c3e25e45664f838de9d0",  # noqa
        "filename": "numpy-1.15.2-cp27-cp27mu-manylinux1_x86_64.whl",  # noqa
        "sha256": "82f00a1e2695a0e5b89879aa25ea614530b8ebdca6d49d4834843d498e8a5e92",  # noqa
    },
}

def _impl(repository_ctx):
    if repository_ctx.name == "numpy":
        fail("Do not name this repository `numpy`. Please name it " +
             "`numpy_py` or something else.")

    os_result = determine_os(repository_ctx)
    if os_result.error != None:
        fail(os_result.error)

    if os_result.is_macos:
        # Add no-op BUILD file to leverage Homebrew.
        repository_ctx.symlink(
            Label("@drake//tools/workspace/numpy_py:package.noop.BUILD.bazel"),
            "BUILD.bazel",
        )
    elif os_result.is_ubuntu:
        platform = "ubuntu_" + os_result.ubuntu_release
        wheel = wheels.get(platform)
        if wheel == None:
            fail("Unsupported platform: {}".format(platform))
        urls = [
            url.format(**wheel)
            for url in repository_ctx.attr.mirrors["pypi-general"]
        ]
        repository_ctx.download_and_extract(
            url = urls,
            sha256 = wheel["sha256"],
            type = "zip",
        )
        repository_ctx.symlink(
            Label("@drake//tools/workspace/numpy_py:package.BUILD.bazel"),
            "BUILD.bazel",
        )
    else:
        fail("Unsupported platform")

numpy_py_repository = repository_rule(
    _impl,
    attrs = dict(
        mirrors = attr.string_list_dict(mandatory = True),
    ),
)

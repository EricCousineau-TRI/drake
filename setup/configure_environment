#!/usr/bin/env python3

"""
Updates drake to use Python3 and produce Python3 bindings.

This generates (or overwrites) `./gen/environment.bazelrc`.
"""

import argparse
import os
from os.path import abspath, dirname, join, isabs, isfile, isdir
import platform

TEMPLATE_BAZELRC = """
# AUTOGENERATED: Do not edit by hand.
# Please use `./setup/configure_environment` instead.
build --python_path={python_bin}
build --action_env=PYTHON_BIN_PATH={python_bin}
""".lstrip()

def main():
    parser = argparse.ArgumentParser(description=__doc__)
    parser.add_argument(
        "--python_bin", type=str, required=True,
        help="Python binary. Must be an absolut path.")
    parser.add_argument(
        "-f", "--force", action="store_true",
        help="Overwrite pre-existing configuration.")
    args = parser.parse_args()

    workspace_dir = dirname(dirname(abspath(__file__)))
    target_relpath = "gen/environment.bazelrc"

    python_bin = args.python_bin
    if not isabs(python_bin):
        parser.error("Please specify an absolute path to the binary.")
    target_abspath = join(workspace_dir, target_relpath)
    if isfile(target_abspath) and not args.force:
        parser.error(
            "'{}' already exists, and will not be overwritten without --force."
            .format(target_relpath))
    if not isdir(dirname(target_abspath)):
        os.makedirs(dirname(target_abspath))

    with open(target_abspath, 'w') as f:
        f.write(TEMPLATE_BAZELRC.format(python_bin=python_bin))

    print("Configured to use: {}".format(python_bin))
    print("In: {}".format(target_abspath))


if __name__ == "__main__":
    main()
